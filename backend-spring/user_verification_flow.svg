<svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
  <!-- Styles -->
  <defs>
    <style>
      .box {
        fill: #f0f8ff;
        stroke: #4682b4;
        stroke-width: 2;
        rx: 10;
        ry: 10;
      }
      .header-box {
        fill: #4682b4;
        stroke: #4682b4;
        stroke-width: 2;
        rx: 10;
        ry: 10;
      }
      .arrow {
        stroke: #4682b4;
        stroke-width: 2;
        fill: none;
        marker-end: url(#arrowhead);
      }
      .text {
        font-family: Arial, sans-serif;
        font-size: 14px;
        text-anchor: middle;
      }
      .header-text {
        font-family: Arial, sans-serif;
        font-size: 18px;
        font-weight: bold;
        fill: white;
        text-anchor: middle;
      }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4682b4" />
    </marker>
  </defs>
  
  <!-- Header Box -->
  <rect x="150" y="20" width="500" height="50" class="header-box" />
  <text x="400" y="50" class="header-text">User Verification Flow</text>
  
  <!-- Main Flow -->
  <!-- Registration -->
  <rect x="225" y="120" width="180" height="50" class="box" />
  <text x="315" y="150" class="text">Registration</text>
  
  <!-- Generate Token & Publish Event -->
  <rect x="225" y="220" width="180" height="60" class="box" />
  <text x="315" y="245" class="text">Generate Token &amp; Publish</text>
  <text x="315" y="265" class="text">Event</text>
  
  <!-- EmailService: Send Verification Email -->
  <rect x="225" y="330" width="180" height="60" class="box" />
  <text x="315" y="355" class="text">EmailService: Send</text>
  <text x="315" y="375" class="text">Verification Email</text>
  
  <!-- User Clicks Link -->
  <rect x="225" y="440" width="180" height="60" class="box" />
  <text x="315" y="465" class="text">User Clicks Link â†’</text>
  <text x="315" y="485" class="text">/verify?token=...</text>
  
  <!-- Rate Limit Check -->
  <rect x="225" y="550" width="180" height="40" class="box" />
  <text x="315" y="575" class="text">Rate Limit Check</text>
  
  <!-- Token Validation -->
  <rect x="225" y="640" width="180" height="40" class="box" />
  <text x="315" y="665" class="text">Token Validation</text>
  
  <!-- Enable User Account -->
  <rect x="225" y="730" width="180" height="40" class="box" />
  <text x="315" y="755" class="text">Enable User Account</text>
  
  <!-- Alt Flow -->
  <!-- Resend Verification -->
  <rect x="475" y="120" width="180" height="50" class="box" />
  <text x="565" y="150" class="text">Resend Verification</text>
  
  <!-- Generate New Token & Publish Event -->
  <rect x="475" y="220" width="180" height="60" class="box" />
  <text x="565" y="245" class="text">Generate New Token &amp;</text>
  <text x="565" y="265" class="text">Publish Event (resend)</text>
  
  <!-- EmailService: Resend with Updated Subject -->
  <rect x="475" y="330" width="180" height="60" class="box" />
  <text x="565" y="355" class="text">EmailService: Resend</text>
  <text x="565" y="375" class="text">with Updated Subject</text>
  
  <!-- Arrows -->
  <!-- Main flow arrows -->
  <line x1="400" y1="70" x2="315" y2="120" class="arrow" />
  <line x1="315" y1="170" x2="315" y2="220" class="arrow" />
  <line x1="315" y1="280" x2="315" y2="330" class="arrow" />
  <line x1="315" y1="390" x2="315" y2="440" class="arrow" />
  <line x1="315" y1="500" x2="315" y2="550" class="arrow" />
  <line x1="315" y1="590" x2="315" y2="640" class="arrow" />
  <line x1="315" y1="680" x2="315" y2="730" class="arrow" />
  
  <!-- Alternative flow arrows -->
  <line x1="400" y1="70" x2="565" y2="120" class="arrow" />
  <line x1="565" y1="170" x2="565" y2="220" class="arrow" />
  <line x1="565" y1="280" x2="565" y2="330" class="arrow" />
  
  <!-- Connect resend verification to main flow -->
  <path d="M 565 390 C 565 420, 450 420, 315 440" class="arrow" />
</svg>